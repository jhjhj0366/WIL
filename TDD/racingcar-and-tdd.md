# 자동차 경주 게임과 TDD

## TDD 를 진행하기 전, 생각 해봐야할 내용

단위 테스트와 TDD를 시작할 때 어디서 어떻게 시작해야할지 모를 때가 많다.

### **도메인 지식을 기반으로 객체 설계 경험이 있는 경우**

도메인 지식을 기반으로 객체 설계 경험이 있는 경우에는 요구사항 분석을 통해 객체를 추출하면 된다. 여기에서 주의할 점은 객체를 추출할 때, **UI(화면), DB(데이터) 등과 의존관계를 가지지 않는 핵심 도메인 영역을 집중 설계해야 한다.**

### **도메인 지식이 없고 객체 설계 경험이 없는 경우**

도메인 지식 기반으로 한 객체 설계 경험이 없는 경우 도메인 설계만으로도 어렵다. 경험 없이 구현을 먼저 진행한다면 흐름 지향적인 코드(절차 지향적인 객체)가 만들어지게 된다. 도메인 지식이 없고 객체 설계 경험이 없는 경우는 해결하고 싶은 문제가 무엇인지 백지에 그려봐야 한다.

**설계에서 연습**

1. TDD를 진행하기 전, **목표로하는 서비스를 시도할 수 있는지 판단한다**. 
→ 목표로 하는 서비스의 todo 리스트를 작성할 수 있는지 확인한다.
2. todo 리스트를 작성한다.

> 💡 객체 지향적인 설계를 추구하고 싶다면 먼저, **기능 목록을 작성해보고,** 기능 목록을 기반으로 각 객체들 간의 어떠한 협력관계로 게임이 진행하는지, 서로 어떠한 메시지를 주고 받는지 생각하며 그림으로 그려보길 추천한다.

**구현에서 연습**

1. 구현이 막막하다면 단위 테스트, 객체 지향적인 설계, 기능 목록을 분리하지 않고 익숙한 방식으로 구현한다.
2. 익숙한 방식으로 구현하면서 구현하려는 프로그래밍의 도메인 지식을 쌓는다.
3. 구현한 모든 코드를 버린다.
4. 구현할 기능 목록을 작성하거나 간단한 도메인을 설계한다.
5. 기능 목록 중 가장 간단한 기능부터 TDD를 이용해 구현한다.
6. 복잡도가 높아져 리팩토링하기 힘든 상태가 되면 다시 버린다.
7. 다시 도전한다.

> 💡 TDD로 진행하기 어렵고, 리팩토링이 진행이 안되고, 자신이 짠 코드가 너무 복잡하다 생각이 들면 코드를 전부 지우고 설계에서부터 다시 시작한다.

## 설계

### 1차 목표 - 기능 요구사항 파악

<img width="599" alt="스크린샷_2022-06-20_오후_12 14 28" src="https://user-images.githubusercontent.com/92219795/174524208-adcb0f0e-6bce-45c6-908f-2b30a524c8bd.png">

### 2**차 목표 - 도메인을 기반으로 모델 설계**

MVC 패턴에서 생각한다면 View와 Controller에 집중하지 않고, 핵심 비즈니스 로직을 담당하는 Model 영역에 집중해야 한다.

여기에서 **뷰와 컨트롤러에서 순수한 모델을 분리**하는 것이 중요하고, 분리한 다음 도메인 객체에만 집중해서 단위 테스트에 집중해야 한다.

<img width="616" alt="스크린샷_2022-06-20_오전_11 42 23" src="https://user-images.githubusercontent.com/92219795/174524242-f58d7f62-ca57-48a3-869d-a2ae6fc51e80.png">

### 3**차 목표 - 테스트 가능한 부분과 테스트 하기 어려운 부분을 분리하라**

여기에서 random 값을 테스트하는 것이 정말 어렵다. 그렇기 때문에 도메인에서 테스트하기 어려운 Random 값 생성하는 구현체를 테스트하려는 도메인들과 분리해  나머지 영역들에 대해서 단위 테스트를 진행한다.

<img width="525" alt="스크린샷_2022-06-20_오전_11 46 37" src="https://user-images.githubusercontent.com/92219795/174524270-ae7a6ca9-4ea5-4de7-9f6e-6a351ded3e56.png">

> 💡 도메인 영역에서 단위 테스트를 진행 할때, 테스트하기 어려운 코드는 도메인에서 분리해 관리한다.

## 구현

### 4**차 목표 - TDD 진행**

1 단계 - Util 성격의 기능이 TDD로 도전하기 좋다.

- 1자 이상, 5자 이하의 정상적인 이름인지 확인
- 자동차 이동 거리에 따라 `-` 생성하기

2 단계 - 테스트 가능한 부분에 대해 TDD로 도전한다.

- 참여자의 이름 split하고 자동차 생성
- 경주에 참여한 자동차 중에서 우승자 찾기

3 단계 - 테스트하기 어려운 부분을 찾아 가능한 구조로 개선한다.

- 자동차 이동 유무
- 우승자 이름 출력하기

### 테스트

**테스트하기 어려운 부분을 찾아 가능한 구조로 개선한다.**

- **Object Graph에서 다른 Object와 의존관계를 가지지 않는 마지막 노드를 먼저 찾는다.**
- 예를 들어 RacingMain → RacingGame → Car와 같이 의존 관계를 가진다면 Car가 테스트 가능한지 확인한다.

**대표적으로 테스트하기 어려운 코드**

내부 동작이 일정하지 않거나, 외부 환경에 영향을 받는 요인들은 테스트하기 어렵다.

- 내부 API
    - Random, shuffle, 날짜
- 외부 API
    - 외부 REST API
    - 데이터베이스 API

**테스트하기 어려운 구조**

마지막 노드가 난수 생성이 되면 전체적인 테스트 진행이 되지 않는다. 그렇기 때문에 Main 까지 의존관계를 올리면 RacingGame과 Car를 테스트할 수 있게 된다.

**마지막 노드가 난수 생성일 때**

<img width="299" alt="스크린샷_2022-06-20_오후_12 33 18" src="https://user-images.githubusercontent.com/92219795/174524294-7a76256a-a741-4d0e-a0ac-6f5cfecdb70a.png">

**RacingGame에 난수 생성을 진행할 때**

<img width="288" alt="스크린샷_2022-06-20_오후_12 34 12" src="https://user-images.githubusercontent.com/92219795/174524325-d7a5dafa-aa7c-48da-9130-f6fc0e3c9020.png">

**RacingMain에서 난수 생성을 진행할 때**

<img width="295" alt="스크린샷_2022-06-20_오후_12 34 43" src="https://user-images.githubusercontent.com/92219795/174524343-0e2c0167-8bee-49d1-a136-f80457e2c706.png">

난수 생성이 제일 마지막에 오게 돼도 Mock 프레임워크를 사용해 테스트를 진행할 수 있지만 상위 노드로 난수 생성을 옮기면서 상위 노드를 제외한 하위 노드에서는 Mock 프레임워크 없이 테스트를 진행할 수 있다.

> 제일 첫 번째 노드에서는 테스트 진행이 어렵다. 보통 최상위 노드에서 테스트를 진행하려면 Mock 프레임워크를 이용해 테스트 해야 한다.


### 왜 Mock 객체로 진행하지는 않는가?

일반적으로 테스트 시간이 오래걸려서 Mock을 사용하지 않고 Stub을 사용할 때가 있다고 생각했는데 이러한 이유 말고도 각각의 방식을 고수해야할 때가 있다고 한다.

- Stub은 **입력값에 따른 결과값을 비교하기 위해서 사용한다.** 추가적으로 특정한 입력값에 대한 예외가 발생하는지 확인하기 위해 사용한다.
- Mock기반의 테스트는 행위 기반의 테스트로 작성이 된다. **그렇기 때문에 특정한 메서드가 정상적으로 호출되었는지 확인하기 위해 사용한다.**